# Technical Architecture

## System Positioning

- **Role**: Sidecar / Sentinel for PoWA
- **Characteristics**:
  - No modification to PoWA code
  - Only consumes data already generated by PoWA

## Architecture

```mermaid
graph TD
    PG[PostgreSQL] --> STAT[pg_stat_statements]
    STAT --> POWA[PoWA (Analyze / Aggregate)]
    POWA --> PUSH[Push Service (Read Only)]
    PUSH --> WECHAT[WeCom / Channels]
```

In the diagram, *PostgreSQL* denotes the source of stats (e.g. pg_stat_statements). In single-server mode it is the same as the PoWA repository database; in multi-server mode it represents the monitored instances that feed data to the repository.

## Data Access Principles

- **Account**: Independent read-only account
- **Scope**: Only `powa` schema aggregation views
- **Restrictions**: No connection to business DBs, no DDL/DML
- **Reference**: See [PoWA Schema](powa-schema.md)

## Project Layout

```
.
├── cmd/powa-sentinel/      # Entry point
├── config/                 # Config templates
├── internal/
│   ├── config/             # Config implementation
│   ├── model/              # Data structures
│   ├── reader/             # DB interaction
│   ├── engine/             # Logic engine
│   ├── notifier/           # Push implementation
│   ├── server/             # HTTP Server (Health Check)
│   └── scheduler/          # Job control
└── pkg/                    # Reusable packages
```

Configuration: see [Config Specification](config-spec.md).

## Core Data Models

### MetricSnapshot

```go
type MetricSnapshot struct {
    QueryID   int64
    Query     string
    TotalTime float64
    MeanTime  float64
    Calls     int64
}
```

### AlertContext

```go
type AlertContext struct {
    ReqID        string
    ReportType   string
    TopSlowSQL   []MetricSnapshot
    Regressions  []RegressionItem
    Suggestions  []IndexSuggestion
}
```

### IndexSuggestion

```go
type IndexSuggestion struct {
    Table                 string
    AccessType            string
    Columns               []string
    EstImprovementPercent float64
}
```

## Component Logic

### Reader

- **Target**: `powa_statements` (live), `powa_statements_history` (baseline), `powa_qualstats_indexes`
- **Strategy**: Query by time window `ts` range

### Rule Engine

1. **Top N**: Sort by `TotalTime` DESC (or `pg_stat_kcache` I/O if enabled)
2. **Regression**: `(Current.MeanTime - Baseline.MeanTime) / Baseline.MeanTime`
3. **Suggestion**: Filter `powa_qualstats_indexes` for high-impact (>30%) missing indexes

### Notifier

- **Retry**: Exponential backoff (1s, 2s, 4s) on network failures

### Health Server

- **Endpoint**: `GET /healthz`
- **Logic**: 200 OK if process runs and can connect to DB (optional deep check)

## Execution Flow

1. Scheduler triggers job
2. Reader fetches current and baseline data
3. Engine analyzes and generates `AlertContext`
4. Notifier formats and sends payload
