# PoWA (PostgreSQL Workload Analyzer) Reference

This document provides context on the upstream [PoWA](https://github.com/powa-team/powa) project and defines the data schema used by `powa-sentinel`.

## 1. Project Overview

**PoWA** is a PostgreSQL Workload Analyzer that gathers performance stats and provides real-time charts and graphs. It relies on the `pg_stat_statements` extension to collect query performance data.

`powa-sentinel` acts as a sidecar to PoWA. Instead of collecting raw data from PostgreSQL directly, it queries the **aggregations** already processed and stored by PoWA. This ensures:
*   Minimal overhead on the database.
*   Consistency with what DBAs see in the PoWA UI.

## 2. PoWA Ecosystem

Understanding the PoWA ecosystem helps clarify the boundaries of `powa-sentinel`.

*   **`powa-archivist` (The Core)**: This is the PostgreSQL extension that runs the background worker. It is responsible for:
    *   Snapshotting data from `pg_stat_statements`.
    *   Storing data in the `powa` database/schema.
    *   **Relation**: `powa-sentinel` connects to the database where `powa-archivist` is installed.

*   **`powa-web` (The UI)**: A web-based dashboard for humans to visualize the data.
    *   **Relation**: Parallel to `powa-sentinel`. `powa-sentinel` is for automated alerting, while `powa-web` is for manual investigation. Alerts may eventually link to `powa-web`.

*   **Data Source Plugins**:
    *   `pg_stat_statements`: (Mandatory) Provides SQL query execution stats (Time, Calls).
    *   `pg_stat_kcache`: (Optional) Provides CPU and Disk I/O metrics.
    *   `pg_qualstats`: (Optional) Provides index and predicate analysis.

## 3. Key Concepts

*   **Repository Database**: The PostgreSQL instance where PoWA stores its history (schema `powa`).
*   **Snapshot**: PoWA regularly collects stats (default every 5 minutes).
*   **Aggregation**: Data is aggregated by time windows (e.g., query stats per snapshot).

## 3. Data Dictionary

The `powa-sentinel` Reader component interacts primarily with the following views in the `powa` schema.

### 3.1 `powa_statements` (View)

This view provides aggregated query statistics. In the context of `powa-sentinel`, we focus on the fields mapped to our internal `MetricSnapshot` model.

| Field Name | Type | Description | Mapping |
| :--- | :--- | :--- | :--- |
| `queryid` | `bigint` | Unique identifier for the normalized query text. | `MetricSnapshot.QueryID` |
| `query` | `text` | Normalized query text (placeholders instead of values). | `MetricSnapshot.Query` |
| `calls` | `bigint` | Number of times the query was executed. | `MetricSnapshot.Calls` |
| `total_time` | `double` | Total time spent executing the query (ms). | `MetricSnapshot.TotalTime` |
| `mean_time` | `double` | Average execution time per call (ms). | `MetricSnapshot.MeanTime` |
| `ts` | `timestamp` | Timestamp of the snapshot/aggregation window. | Used for Time Window filtering |

> **Note**: The actual column names in the PoWA backing tables (e.g., `powa_statements_src`) might differ slightly depending on the PoWA version, but `powa-sentinel` relies on the standard view interface.

### 3.2 `powa_statements_history` (Table/View)

This table stores the historical aggregated performance statistics. It is critical for detecting trends and regressions over time.

| Field Name | Type | Description | Usage |
| :--- | :--- | :--- | :--- |
| `queryid` | `bigint` | Unique identifier for the query. | Join with `powa_statements` |
| `ts` OR `coalesce_range` | `timestamp/tstzrange` | Time window of the aggregation. | Time-series analysis |
| `calls` | `bigint` | Number of calls in this time window. | Volume analysis |
| `total_time` | `double` | Total execution time in this window. | Performance analysis |
| `mean_time` | `double` | Average time per call in this window. | Regression calculation |

> **Critical**: The **Regression Ratio** logic relies on comparing the `mean_time` from the *current window* (live data) against the `mean_time` from this history table (baseline data).

### 3.3 `powa_databases` (Table)

Maps internal IDs to human-readable database names.

| Field Name | Type | Description |
| :--- | :--- | :--- |
| `dbid` | `oid` | Database OID. |
| `datname` | `text` | Database name. |

## 4. Derived Metrics


## 5. Supported Extensions and Data Sources

The following extensions are supported by `powa-sentinel` to enhance alerts.

### 5.1 Core Scope

*   **`pg_stat_kcache`**:
    *   **Value**: Adds physical resource metrics (CPU, Disk I/O) to the query stats.
    *   **Usage**: Used for analyzing "CPU/IO Intensive" slow queries.

*   **`pg_qualstats`**:
    *   **Value**: Suggests missing indexes.
    *   **Usage**: Identifying "Optimization Opportunities" (Index Suggestions).
    *   **Mechanism**: Passive read of suggestions generated by PoWA.

*   **`pg_wait_sampling`**:
    *   **Value**: Provides the "Why" behind a slow query.
    *   **Usage**: Future support for "Locking Alert".
