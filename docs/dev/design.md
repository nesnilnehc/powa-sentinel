# Technical Architecture & Design

## 1. System Positioning & Architecture

### 1.1 Positioning
*   **Role**: Sidecar / Sentinel for PoWA.
*   **Characteristics**:
    *   No modification to PoWA code.
    *   Only consumes data already generated by PoWA.

### 1.2 Architectural Relationships
```mermaid
graph TD
    PG[PostgreSQL] --> STAT[pg_stat_statements]
    STAT --> POWA[PoWA (Analyze / Aggregate)]
    POWA --> PUSH[Push Service (Read Only)]
    PUSH --> WECHAT[WeCom / Channels]
```

### 1.3 Data Access Principles
*   **Account**: Independent read-only account.
*   **Scope**: Only `powa` schema aggregation views.
*   **Restrictions**: No connection to business DBs, no DDL/DML.
*   **Reference**: See [PoWA Reference](./powa_reference.md) for schema details.

## 2. Project Layout
Standard Go Project Layout:
```
.
├── cmd/powa-sentinel/      # Entry point
├── config/                 # Config templates
├── internal/
│   ├── config/             # Config implementation
│   ├── model/              # Data structures
│   ├── reader/             # DB interaction
│   ├── engine/             # Logic engine
│   ├── notifier/           # Push implementation
│   ├── server/             # HTTP Server (Health Check)
│   └── scheduler/          # Job control
└── pkg/                    # Reusable packages
```

## 3. Configuration Specification
```yaml
database:
  host: "${DB_HOST:-127.0.0.1}" # Env Var support
  dbname: "powa"

schedule:
  cron: "0 9 * * 1" 

analysis:
  window_duration: "24h" 
  comparison_offset: "168h" 
  
rules:
  slow_sql: { top_n: 10 }
  regression: { threshold_percent: 50 }

notifier:
  type: "wecom"
  retries: 3
```

## 4. Core Data Models
### 4.1 MetricSnapshot
```go
type MetricSnapshot struct {
    QueryID      int64
    Query        string
    TotalTime    float64
    MeanTime     float64
    Calls        int64
}
```

### 4.2 AlertContext
```go
type AlertContext struct {
    ReqID        string
    ReportType   string 
    TopSlowSQL   []MetricSnapshot
    Regressions  []RegressionItem
    Suggestions  []IndexSuggestion
}

### 4.3 IndexSuggestion
```go
type IndexSuggestion struct {
    Table      string
    AccessType string // e.g., Seq Scan
    Columns    []string
    EstImprovementPercent float64 // HypoPG impact
}
```
```

## 5. Component Logic

### 5.1 Reader
*   **Target**: 
    *   `powa_statements` (Live) & `powa_statements_history` (Baseline).
    *   `powa_qualstats_indexes` (Read-only view of suggested indexes).
*   **Strategy**: Query by time window `ts` range.

### 5.2 Rule Engine
1.  **Top N**: Sort by `TotalTime` DESC. (Check `pg_stat_kcache` for I/O Time if enabled).
2.  **Regression**: `(Current.MeanTime - Baseline.MeanTime) / Baseline.MeanTime`.
3.  **Suggestion**: Filter `powa_qualstats_indexes` for high-impact (>30%) missing indexes.

### 5.3 Notifier
*   **Retry Policy**: Implement Exponential Backoff (e.g., 1s, 2s, 4s) for network failures.

### 5.4 Health Server (`internal/server`)
*   **Endpoint**: `GET /healthz`
*   **Logic**: Return 200 OK if the process is running and can connect to DB (optional deep check).



## 6. Execution Flow
1.  **Scheduler** triggers job.
2.  **Reader** fetches Current and Baseline data.
3.  **Engine** analyzes and generates `AlertContext`.
4.  **Notifier** formats and sends payload.
