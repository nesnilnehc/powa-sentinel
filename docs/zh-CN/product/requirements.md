# 产品需求文档

## 1. 背景与目标

### 1.1 背景

* **现状**: PoWA (PostgreSQL Workload Analyzer) 已经具备完整的性能采集和分析能力。
* **痛点**:
  * 目前仅提供 Web 可视化。
  * 缺乏主动通知、异常检测和趋势告警能力。
  * 在企业运维和研发协作中，“人不会主动看监控”是常态。

### 1.2 目标

构建一个 **独立、低风险、长期运行** 的 PoWA 推送服务，以实现：
> 将 PoWA 的“分析结果”转化为可操作的信息，并通过企业通讯渠道（如企业微信）主动触达相关人员。

## 2. 核心需求

### 2.1 功能需求

系统必须实现以下核心功能：

1. **数据采集**:
    * 定期从 PoWA 数据库获取性能统计信息。
2. **场景识别**:
    * 识别 **Slow SQL Top N**，基于规则：
        * 按持续时间（标准）。
        * 按 CPU / IO（通过 `pg_stat_kcache`，如果可用）。
    * 识别 **查询持续时间/计数的异常增长**。
    * 识别 **性能衰退**。
    * 识别 **优化机会**（新）：
        * **缺失索引建议**（通过 `pg_qualstats` + `hypopg`）。
3. **消息推送**:
    * 将分析结论作为消息推送到企业微信 (WeCom)。
4. **扩展性**:
    * 支持未来扩展至飞书、钉钉、邮件或 Webhook。

### 2.2 非功能需求

1. **低侵入性**:
    * 不影响 PoWA 的正常运行。
    * 不引入数据库控制行为。
2. **安全性**:
    * 不访问业务数据。
3. **稳定性**:
    * 能够长期稳定运行。
4. **可维护性**:
    * 部署和运维成本低。
5. **自监控**:
    * 服务必须暴露自身的健康状态 (Health Checks) 供容器编排系统使用。

### 2.3 先决条件

为确保系统能正确识别“趋势”和“异常”，目标 PoWA 实例必须满足以下条件：

1. **历史数据存储**: 必须启用历史数据持久化。
2. **数据保留期**: PoWA 中的数据保留时长必须覆盖所需的分析窗口。
    * 例如，如果需要“周同比”分析，PoWA 需要保留至少 8 天的数据 (`> 7 天`)。

## 3. 推送内容设计原则

### 3.1 核心原则

推送 **“结论”**，而不是 “原始数据”。消息内容应关注：指标、对比、趋势、影响评估。

### 3.2 信息分级

* **L1 (管理层)**: 汇总结论（例如，“数据库健康度降至 80%”）。
* **L2 (技术负责)**:
  * **性能**: 慢 SQL HASH + 持续时间/CPU 变化。
  * **优化**: “表 X 缺少针对查询 Y 的索引（预计提升：50%）”。
* **L3 (DBA)**: 完整 SQL 文本、执行计划链接、直接的 `powa-web` URL。

## 4. 用户故事

### 4.1 管理层 / 大群成员 (L1)

作为一名 **管理者**，我希望：

* 收到 **汇总结论** 以快速了解数据库健康状态。
* 看到 **影响评估** 以决定是否干预和协调资源。
* **不** 看到复杂的 SQL 语句或细节，以避免信息过载。

### 4.2 技术负责人 (L2)

作为一名 **技术负责人**，我希望：

* 看到 **SQL Hash** 以快速定位有问题的 SQL。
* 看到 **关键指标的变化** 以评估性能波动对业务的影响。

### 4.3 DBA / 私有群成员 (L3)

作为一名 **DBA**，我希望：

* 查看 **SQL 片段** 或 **完整分析报告** 以进行深入诊断和优化。
* 收到 **详细告警信息** 以立即响应数据库异常。
* 收到 **索引优化建议** 以在问题发生前主动提升系统性能。

### 4.4 系统运维

作为一名 **系统运维工程师**，我希望：

* 推送服务作为 **独立进程** 运行，不修改现有的 PoWA 架构。
* 服务具有 **只读权限**，确保数据库安全。

## 5. 合规与安全需求

* **数据范围**: 仅处理性能元数据。
* **系统定位**: 运维监控辅助系统。
* **风险评估**: 低风险且高度可控。

## 6. 路线图

1. **配置增强**: 支持可配置规则 (YAML / DSL)。
2. **架构扩展**: 支持多实例 / 多租户。
3. **智能降噪**: 实现推送去重和抑制。
4. **关联分析**: 关联发布/变更事件。
